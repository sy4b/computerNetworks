# 4.1 网络层的功能
向上提供简单灵活的，**无连接**的**数据报**服务

> 1. Internet网络层有四个重要协议：IP、ICMP、ARP、RARP（逆地址解析协议） 

## 4.1.1 异构网络互联
中继系统分为以下四种
1. 物理层中继系统：转发器、集线器
2. 数据链路层中继系统：网桥或交换机
3. 网络层中继系统：路由器
4. 网络层以上的中继系统：网关

网络互联：用路由器进行网络互联和路由选择

**路由器是专用计算机，用于在互联网中进行路由选择**

## 4.1.2 路由选择和分组转发
路由选择：根据算法，动态改变路由
分组转发：根据转发表将用户的IP数据报从合适的端口转发出去

路由表由路由选择算法得到，转发表从路由表得出

## 4.1.3 SDN 软件定义网络
将网络层分离为：**数据层面（转发）和控制层面（路由选择）**

1. 控制层面集中化
2. 控制与转发功能分离
3. 接口开放可编程

各种接口：

1. **对于上层的应用的开发者，SDN提供的编程接口称为北向接口**，可以在此基础上设计自己的应用，不必关心底层的硬件细节
2. **SDN控制器和转发设备建立双向对话的接口称为南向接口**
3. **SDN控制器集群内部控制器之间的通信接口称为东西向接口**，用于增强整个控制层面的可靠性和可拓展性

> 1. (22 408) SDN网络体系结构中，SDN控制器向数据平面的SDN交换机下发流表时使用的接口是：南向接口


## 4.1.4 拥塞控制
**拥塞：通信子网中，出现过量分组引起网络性能下降**

判断网络是否进入拥塞状态：**观察吞吐量和网络负载的关系**

1. 随着负载增加，吞吐量明显小于正常的吞吐量，说明进入轻度拥塞
2. 随负载增加，吞吐量下降，进入拥塞
3. 吞吐量下降到0，进入死锁

**拥塞是全局性问题，涉及网络中所有主机、路由器等（区别于流量控制）**

拥塞控制方法：

1. 开环控制，静态：设计网络时事先考虑有关发生拥塞的因素，力求在网络工作时不产生拥塞
2. 闭环控制，动态：事先不考虑拥塞的各种因素，采用监测网络系统进行监视，及时检测哪里发生了拥塞，进行处理

# 4.2 路由算法
> 路由选择分直接交付和间接交付
> 直接交付时，两台主机在同一个网段内，不涉及路由器
> 间接交付时，两台主机不在同一个网段，需要路由器转发，同时也涉及直接交付


## 4.2.1 静态路由和动态路由
**路由表转发分组需要通过路由表转发**。路由表是通过各种算法得到的。可以分为

1. 静态路由算法（非自适应路由算法）：网络管理员手动配置路由信息
2. 动态路由算法（自适应路由算法）：路由表项通过相互连接的路由器之间彼此交换信息，按照一定算法优化得到

常用动态路由算法可分为：

1. 距离-向量算法
2. 链路状态路由算法

## 4.2.2 距离-向量算法
1. 所有节点定期将他们的路由选择表传送给**所有与之直接相邻的节点**
2. **所有节点必须参与距离向量交换**，以保证路由的有效性和一致性

常见距离-向量算法：**RIP**（使用路由器的跳数作为距离

路由选择表包括：

1. 每条路径的目的地（另一个节点
2. 路径的代价（距离

> 1. 距离-向量路由协议中，**慢收敛导致路由器接受无效的路由信息**可能导致路由回路

### 更新路由表的情况
1. 被通告一条新的路由，该路由在本节点的路由表中不存在，此时本地系统加入这条新的路由
2. 发来的路由信息中有一条到达某个目的地的路由，该路由和目前使用的路由相比有较短的距离，此时用新路由替换

## 4.2.3 链路状态路由算法
1. 要求**每个参与该算法的节点都具有完全的网络拓扑信息**
2. 节点更新网络图利用**Dijkstra算法**
3. 向本自治系统发送信息，使用方法是**洪泛法，即路由器通过所有端口向相邻路由器发送信息**

**典型链路状态路由算法：OSPF算法**

## 4.2.4 层次路由
网络规模扩大时，路由表成比例增大，会消耗越来越多路由器缓冲区空间、CPU时间等

1. Internet将整个互联网划分成许多小的自治系统，每个自治系统包含很多局域网
2. 每个自治系统有权自主决定本系统内采用何种路由选择协议
3. 两个自治系统之间通信时，采用协议屏蔽差异

内部网关协议（IGP）：一个自治系统内部使用的路由选择协议（例如RIP、OSPF
外部网关协议（RGP）：自治系统之间所使用的路由选择协议（例如BGP

# 4.3 IPv4
IP协议（版本4）：定义数据传送的基本单元——IP分组及确切的数据格式。指明分组如何处理，错误如何控制
## 4.3.1 IPv4分组
### 1. IPv4分组的格式
**一个IP分组由首部和数据部分组成。首部前一部分长度固定，共20B，是所有IP分组必须有的；首部固定部分后面是可选字段，长度可变，用于提供错误检测及安全等机制**

![请添加图片描述](https://img-blog.csdnimg.cn/5fff65945025468bb9fae828c0086077.jpeg)
1. 版本：指IP协议版本，目前广泛使用版本号为4（IPv4
2. **首部长度：表示首部的长度，4位，表示0～15，以4B为单位，最大可以是60B。最常用的首部长度是20B，此时首部长度字段为0101**
3. **总长度：首部和数据的长度之和，单位为1B**
4. 标识：计数器，生成一个数据报就加1。分片时每个数据报片都复制一个标识，以便组装。不是“序号”，因为IP无连接服务
5. 标志：与分片相关。中间位DF（dont fragment）：0表示允许分片，1表示禁止分片；最低位MF（more fragment）：0表示后面没有分片，这是最后一片；1表示后面还有分片
6. **片偏移：分片的相对位置，以8B为单位**
7. 生存时间（TTL）：数据报可在网络中通过的路由器数目的最大值，确保数据报不会永远在网络中循环。路由器转发分组前，先TTL-1，TTL=0则丢弃
8. **协议：分组携带的数据使用什么协议，6表示TCP，17表示UDP**
9. **首部校验和：只校验首部**
10. 源地址，目的地址：发送方和接收方的IP地址 

### 2. IP数据报分片
IP数据报被封装在链路层数据报中，因此，链路层MTU（最大传送单元）限制着IP数据报的长度。超过一定长度需要对IP数据报分片

以太网的MTU为1500B

1. 标识：分片标识一致表示属于同一个数据报
2. 标志：与分片相关。中间位DF（dont fragment）：0表示允许分片，1表示禁止分片；最低位MF（more fragment）：0表示后面没有分片，这是最后一片；1表示后面还有分片
3. 片偏移：分片后在原数据报中关于0的相对位置，**以8B为单位**
4. **每一片的有效数据长度必须是8B的整数倍**

![请添加图片描述](https://img-blog.csdnimg.cn/6494022604f446e385e9f1ecabc238e5.jpeg)

>1. DF=1，分组长度又超过MTU时，需要丢弃分组，并向源主机报告
>2. （22 408）
![在这里插入图片描述](https://img-blog.csdnimg.cn/d79eb8c059c2495cae4bf321662a8760.jpeg)



## 4.2.3 IPv4地址与NAT

### 1. IPv4地址
连接到因特网的每台主机或路由器都分配一个**32bit**的全球唯一标识符，即IP地址

分类IP地址（ABC三类重要

![请添加图片描述](https://img-blog.csdnimg.cn/ad5a270ee0cc4a7a8bff05a77db3d60b.jpeg)
**IP地址由网络号和主机号组成**

1. 网络号标志主机所连接到的网络
2. 主机号标志该主机

特殊IP地址

1. **主机号全0表示本网络本身**，例如202.98.174.0
2. **主机号全1表示本网络的广播地址，又称直接广播地址**，例如202.98.174.255
3. **网络号127保留为环回自检地址**，目的地址为环回地址的IP数据报永远不会出现在任何网络上
4. **32位全0，表示本网络的本主机**
5. **32位全1，即255.255.255.255，表示整个TCP/IP网络的广播地址**，又称**受限广播地址**。实际中由于路由器分隔广播域，255.255.255.255等效本网络广播地址

|网络类别|最大可用网络数|第一个可用网络号|最后一个可用网络号|每个网络中最大主机数|
|---|---|---|---|---|
|A|2^7-2（全0，环回自检）|1|126|2^24-2|
|B|2^14|128.0（已经可指派）|191.255|2^16-2|
|C|2^21|192.0.0（已经可指派）|223.255.255|2^8-2|

IP地址特点：

1. IP地址管理机构在分配IP地址时只分配网络号，主机号由得到该网络的单位自行分配
2. **路由器仅根据目的主机连接的网络号转发分组**
3. IP网络上的一个路由器必然至少有两个IP地址（连接到两个网络上，每个端口至少分配一个IP地址）
4. 转发器或桥接器连接的若干LAN属于同一个广播域，该LAN所有主机网络号相同，主机号不同

### 2. 网络地址转换NAT

划分出部分IP地址为私有IP地址，只用于LAN，不用于WAN连接，并且允许私有IP地址被LAN重复使用，有效解决IP地址不足的问题

NAT：将专用网络地址转化为公用地址

私有IP地址范围需要记住！！
![请添加图片描述](https://img-blog.csdnimg.cn/c1f1e85f84804620943099f3d911f88f.png)
1. 使用NAT需要在专用网连接到因特网的路由器上安装NAT软件，NAT路由器至少有一个有效的外部全球IP地址
2. NAT路由器使用NAT转换表进行地址转换
3. **NAT路由器涉及传输层（端口号）。普通路由器仅工作在网络层**

![请添加图片描述](https://img-blog.csdnimg.cn/eb93f09d4aae4763994f616a631316f9.jpeg)
## 4.3.3 子网划分、子网掩码、CIDR
### 1. 子网划分
1. 子网划分属于一个单位内部的事情，对外表现为没有划分子网的网络
2. **从主机号中分出若干比特作为子网号**
3. 三级IP地址结构：网络号、子网号、主机号
4. 子网号全0全1不一定可以使用
5. 主机号全0全1依旧无法指派

> 子网划分必须覆盖所有的网络号，例如：
> （19 408）将101.200.16.0/20划分成5个子网，则可能的最小子网的可分配IP地址数量？
> 网络号前20位：101,200,0001
> 划分子网：
> 0...
> 10...
> 110...
> 1110...
> 1111...	子网内主机数目最少，2^8-2=254个

### 2. 子网掩码
1. 长度32bit，由一串1和跟随的一串0组成
2. **1对应IP地址中的网络号和子网号，0对应主机号**
3. 将IP地址和对应的子网掩码逐位与，得到子网的网络地址
4. 默认子网掩码：255.0.0.0（A类），255.255.0.0（B类），255.255.255.0（C类）

### 3. 无分类编址CIDR
![请添加图片描述](https://img-blog.csdnimg.cn/9d4657f312ad4b68ba36ae18211ed4d4.png)
1. CIDR没有指明若干位作为子网字段，但分配到一个CIDR地址块的组织，可以根据需要划分子网。例如/20，可以继续分配8个子网，每个子网网络前缀变为23位

![在这里插入图片描述](https://img-blog.csdnimg.cn/dde6500249124ef9b47d6a160208b0a5.jpeg)


#### 路由聚合（超网）
**路由聚合：将网络前缀都相同的连续IP地址组成CIDR地址块**

> 网络1：206.1.0.0/17；网络2：206.1.128.0/17	依次是
> 11100010,00000001,0)0000000,00000000
> 11100010,00000001,1)0000000,00000000
> 前16位相同，聚合成
> 206.1.0.0/16

> 1. CID技术的作用：将小的网络汇聚成大的超网

#### 最长前缀匹配（最佳匹配
查找路由表时可能得到不止一个匹配结果，此时**应该选择具有最长网络前缀的路由**。**网络前缀越长，地址块越小，路由越具体**

常用数据结构：**二叉线索**。更有效查找最长前缀匹配

### 4. 网络层转发分组过程
1. 分组转发基于目的主机所在网络（网络前缀
2. 转发表中，每条路由必须有：（目的网络，下一跳地址）
3. **CIDR编址时，路由表多个匹配时，应该选择前缀最长的一个**



得到下一跳路由器的IP地址后，不是直接将这个地址填入待发送的数据报，而是将该IP地址转换为MAC地址（ARP），将该MAC地址放到MAC帧首部中，然后根据MAC地址找到下一跳路由器

在不同网络中传送时，MAC帧中的源地址和目的地址要发生变化；网桥在转发帧时，不改变帧的源地址

## 4.3.4 ARP、DHCP、ICMP
### 1. IP地址与硬件地址
1. 网络层使用IP地址，数据链路层使用MAC地址
2. IP地址位于IP数据报首部，MAC地址位于MAC帧首部。
3. IP数据报分组封装成MAC帧后，数据链路层看不见数据报分组中的IP地址

由于路由器的隔离，IP网络中无法通过广播MAC地址来完成跨网络的寻址。**网络层只使用IP地址完成寻址。** IP分组转发到目标网络后，改**在目标LAN中通过数据链路层MAC地址以广播方式寻址**

> 1. 数据报到达目的网络后，要传送到目的主机，需要知道IP地址对应的物理地址（MAC地址）
> 2. 不考虑NAT，Internet中，IP数据报从源节点到目的节点可能经过多个网络和路由器，整个传输过程中：**IP数据报头部的源地址和目的地址都不会变**

路由器转发IP分组时，IP分组在每个网络中都被路由器解封装和重新封装，MAC帧首部中的源地址和目的地址会不断改变

路由器互联多个网络，有多个IP地址，多个MAC地址

### 2. 地址解析协议ARP
1. 在实际的链路上传送数据帧必须使用硬件地址，所以需要**将IP地址映射到MAC地址**，即使用ARP
2. 每台主机都有一个ARP高速缓存，存放本局域网上各主机和路由器的IP地址到MAC地址的映射表（ARP表）并动态维护

#### 工作原理
主机A要向**本局域网中**的某台主机B发送IP数据报

1. 先在ARP高速缓存中查看有无B的IP地址
2. 如果有，那么查出对应MAC地址，写入MAC帧，发送到硬件地址
3. 如果没有，那么**通过目的地址为FF-FF-FF-FF-FF-FF的帧来封装并广播ARP请求分组（广播）**，局域网内所有主机都收到该ARP请求。
4. **主机B收到ARP请求后，向主机A发送ARP相应（单播）**，分组包含B的IP和MAC地址。主机A收到后将其写入ARP缓存，然后发送MAC帧
5. 如果目的主机在另一个网络，那么发送到路由器，剩下的工作由路由器完成

### 3. 动态主机配置协议 DHCP
1. **DHCP是应用层协议，基于UDP**
2. 用于给主机动态分配IP地址。提供即插即用的联网机制，允许一台计算机加入新的网络和获取IP地址而不用手动参与

#### 工作原理
1. 使用**客户/服务器模式**
2. 需要IP地址的主机在启动时向DHCP服务器**广播**发送**发现报文**，**该主机称为DHCP客户**
3. 只有**DHCP服务器**回答该广播报文。DHCP服务器在数据库中查找该计算机的配置信息，如果找到，返回该计算机的信息；否则，从IP地址池中取一个地址分配给该计算机
4. DHCP服务器的回答报文称为**提供报文**

DHCP服务器和DHCP客户端交换过程：

1. DHCP客户机广播**DHCP发现**消息，源地址0.0.0.0（本网络本主机），目的地址255.255.255.255（本网络广播地址）
2. DHCP服务器收到**DHCP发现**消息后，广播**DHCP提供**消息，源地址为DHCP服务器IP地址，目的地址255.255.255.255（本网络广播地址）
3. DHCP客户机收到**DHCP提供**消息后，如果接受该IP地址，则广播**DHCP请求**消息，请求提供IP地址，源地址0.0.0.0，目的地址255.255.255.255
4. DHCP服务器广播**DHCP确认**消息，将IP地址分配给DHCP客户机，源地址为DHCP服务器IP地址，目的地址255.255.255.255

#### DHCP注意事项
1. **DHCP允许在网络上配置多台DHCP服务器**，客户机发出DHCP发现消息，可能得到多个应答，此时DHCP客户机只会挑选其中一个，**通常选最先到达的**
2. **DHCP服务器分配给客户的IP地址是临时的（租用期）**
3. **DHCP客户端和服务端使用广播方式交互，采用UDP而不是TCP，因为TCP需要建立连接**

### 4. 网际控制报文协议 ICMP
1. **ICMP工作在网络层**
2. ICMP设计是为了**提高IP数据报成功交付的概率**
3. **ICMP报文作为IP层数据报的数据，加上数据报首部，组成IP数据报发送**

ICMP报文包括：**ICMP差错报告报文**和**ICMP询问报文**

ICMP两个常见应用：
1. **分组网间探测PING，用于测试两台主机连通性。使用ICMP回送请求和回答报文（PING工作在应用层，直接使用ICMP，没有使用传输层的TCP或UDP**
2. **Traceroute，跟踪分组经过的路由。使用ICMP时间超过报文（Traceroute工作在网络层**

#### ICMP差错报告报文
**用于目标主机或到达目的主机路径上的路由器向源主机报告差错和异常情况**

1. 终点不可达：路由器或主机不能交付数据报
2. 源点抑制：路由器或主机由于拥塞而丢弃数据报。提醒源点降低数据报发送速率
3. 时间超过：路由器接收到生存时间为0的数据报
4. 参数问题：路由器或目的主机收到的数据报首部有的字段值不对
5. 改变路由（重定向）：提醒主机下次将数据报发送给其他路由器（可通过更好的路由

**不发送ICMP差错报告报文**的情况：

1. 对ICMP差错报告报文，不发送ICMP差错报告报文
2. 对第一个分片的数据报片的所有后续数据报片都不发送
3. 对组播地址的数据报不发送
4. 对特殊地址（127.0.0.0或0.0.0.0）的数据报不发送

#### ICMP询问报文
包括：**回送请求和回答报文、时间戳请求和回答报文、地址掩码请求和回答报文、路由器询问和通过报文**

# 4.4 IPv6
![请添加图片描述](https://img-blog.csdnimg.cn/c83d5c0795374a25863a582455408858.png)


![请添加图片描述](https://img-blog.csdnimg.cn/e8b905b516764bb58fa5deddb182e29e.png)
![请添加图片描述](https://img-blog.csdnimg.cn/130e659a9f884fa8b6a913a2d544d5d2.png)
![请添加图片描述](https://img-blog.csdnimg.cn/b00e58fd6d714686a800e8db1d0c3ca9.png)
> 1. IPv6不允许分片



# 4.5 路由协议
![在这里插入图片描述](https://img-blog.csdnimg.cn/41000e7bf1ee4a6f8b6c2ab9d1a41bf8.png)


> 1. **直接封装RIP、OSPF、BGP报文的协议分别是：UDP、IP、TCP**
## 4.5.1 自治系统 AS
自治系统：单一技术管理下的一组路由器，使用一种**AS内部的路由选择协议**和共同的度量来确定该AS内的路由；同时使用一种**AS之间的路由选择协议**来确定分组在AS之间的路由

一个AS内的所有路由器在本AS内必须是都连通的

## 4.5.2 域内路由和域间路由
域内路由选择：AS内部使用的路由选择
域间路由选择：AS之间的路由选择

### 1. 内部网关协议（IGP
一个AS内部使用的路由选择协议，与互联网中其他AS选用何种路由选择协议无关

使用比较多的有RIP和OSPF

### 2. 外部网关协议（EGP

**源站和目的站处于不同AS中，数据报传到一个AS的边界时（两个AS可能使用不同的IGP），需要使用外部网关协将路由选择信息传递到另一个AS中**

## 4.5.3 路由信息协议（RIP
RIP基于距离-向量路由选择协议

1. **RIP是应用层协议**，**使用UDP传送数据**（端口520）
2. RIP选择的路径不一定是时间最短的，但一定是**具有最少路由器的**
![请添加图片描述](https://img-blog.csdnimg.cn/05e05c9b624f466fbd2091255b711e29.png)
![请添加图片描述](https://img-blog.csdnimg.cn/443056c5646a497083d7b108d8583573.png)


### 1. RIP规定
1. 网络中每个路由器都要维护自身到其他每个网络的距离记录（一组距离，称为**距离向量**
2. 距离也称作跳数，从一个路由器到直接相连网络的跳数为1，没经过一个路由器，跳数+1
3. RIP优先选择跳数少的路径
4. **RIP规定一条路径最多只能包含15个路由器，超出表示网络不可达（防止数据报不断循环，减少网络拥塞可能性）。可见RIP只适用于小型网络**
5. RIP默认在任意两个使用RIP的路由器之间**每30s**广播一次RIP路由更新信息，以便自动建立并动态维护路由表
6. RIP中不支持子网掩码的RIP广播，因此**RIP中每个网络的子网掩码必须相同**（RIP2中支持变长子网掩码和CIDR

### 2. RIP特点
1. 仅和**相邻路由器**交换信息
2. **路由器交换的信息是当前路由器知道的所有信息，即自己的路由表**
3. 按照**固定的时间间隔交换路由信息**
4. 适用于小型互联网
5. 慢收敛：**网络故障时，出现慢收敛（需要较长时间才能将此信息传送到所有路由器**

### 3. 距离向量算法
每个路由表项目包含：**<目的网络N，距离d，下一跳路由器地址X>**

对于每一个相邻路由器发送的**RIP报文**，执行：

1. 对地址为X的相邻路由发来的RIP报文，修改报文中的所有项目：**把下一跳字段中的地址都改成X**，并把所有**距离字段+1**
2. 修改后的RIP报文中的每个项目，执行：
	1. 原来的路由表中没有目的网络N时，该项目添加到路由表中
	2. 原来的路由表中有目的网络，且下一跳路由地址为X时，用收到的项目替换原来的
	3. 原来的路由表中有目的网络，且下一跳路由地址为不是X时，如果收到的项目中的距离d小于路由表中的距离，那么替换；否则不做任何操作
3. 如果**180s还没有收到相邻路由器的更新路由表（RIP默认），那么将此相邻路由器记为不可达路由器，距离设置为16**
4. 返回

RIP优点：实现简单、开销小、收敛过程快

RIP缺点：

1. **限制了网络规模，可使用最大距离为15**
2. 路由器交换完整路由表，开销大
3. **网络故障时，出现慢收敛（需要较长时间才能将此信息传送到所有路由器**

> 1. 路由收敛是指：网络设备的路由表与网络拓扑结构保持一致

![请添加图片描述](https://img-blog.csdnimg.cn/78f569f568af4e45ba764d26a90c9778.jpeg)


## 4.5.4 开放最短路径优先协议（OSPF
OSPF是网络层协议，不使用UDP或TCP，直接用IP数据报传送（首部协议字段89
### 1. 基本特点
1. 向本AS中所有路由器发送信息，使用**洪泛法**
2. **发送的信息是与本路由器相邻的所有路由器的链路状态，仅包含路由器所知道的部分信息**
3. **只有链路状态变化时，才使用洪泛法向所有路由器发送此信息，更新过程收敛快，不会出现RIP慢收敛的问题**
4. 对于不同链路可以根据IP分组的不同服务类型设置不同代价，灵活
5. 到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径（**多路径间负载均衡**
6. 所有在OSPF路由器之间交换的分组都有鉴别功能，保证了仅在可信赖的路由器之间交换链路状态信息
7. 支持可变长度子网划分和CIDR
8. 每个链路状态都带上32bit序号，序号越大，链路状态越新
9. **适用于互联网规模很大的情况**
10. **每隔30min，要刷新一次数据库的链路状态** 

### 2. OSPF基本工作原理
![请添加图片描述](https://img-blog.csdnimg.cn/88604ae29927412184de577d157040cb.png)

各路由器之间频繁交换链路状态信息，所有路由器最终能够建立起一个**链路状态数据库（实际上是全网的拓扑结构图）**，他在全网范围内一致。**每个路由器根据这个全网拓扑结构图，使用Dijkstra算法得到最优路径，构造路由表**。此后链路状态变化时，每个路由器重新计算，构造新的路由表

---


为使OSPF用于更大规模的网络，OSPF将一个AS再划分为若干更小的范围，称为**区域**。
![请添加图片描述](https://img-blog.csdnimg.cn/ad8d201f372d45699982b632620176f4.png)
主干路由器：主干区域中的路由器
区域边界路由器：位于区域边界的路由器
自治系统边界路由器：连接其他AS的路由器
区域内部路由器：位于区域内部的路由器

1. 使用洪泛法交换链路状态信息的范围局限于每个区域而非整个AS，减少通信量
2. 一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑情况
3. 区域有层次之分，处于上层的域为**主干区域**，负责连通下层区域，并且连接其他自治域

### 3. OSPF五种分组类型
1. 问候分组，用于发现和维持邻站的可达性（Hello
2. 数据库描述分组，向邻站给出自己的链路状态数据库中所有链路状态项目的摘要信息（DD
3. 链路状态请求分组，向对方请求发送某些链路状态（LSR
4. 链路状态更新分组，用洪泛法对全网更新链路状态（LSU
5. 链路状态确认分组，对链路更新分组的确认（LSAck

> 1. OSPF协议使用hello分组保持与邻居的连接

## 4.5.5 边界网关协议
不同AS的路由器之间交换路由信息，属于外部网关协议，常用于互联网的网关之间

1. **BGP采用路径向量路由选择协议，区别于距离向量协议和链路状态协议**
2. **BGP工作在应用层，基于TCP**
3. BGP只能力求找到一条能够到达目的网络且比较好的路由（不兜圈子）而**不是一条最佳路由**

### BGP工作原理
1. **每个AS的管理员需要至少选择一个（可以有多个）路由器作为该AS的“BGP发言人”**（BGP边界路由器
2. 每个发言人和其他AS中的发言人交换路由信息，需要**建立TCP连接**。在此连接上交换BDP报文以建立BGP对话，交换路由信息
3. 所有BGP发言人互相交换**网络可达性信息（到达目的网络需要经过的一系列AS）**后，就可以找出到达各个AS之间的较好路由
4. **每个BGP发言人出了运行BGP之外，还需要运行该AS内部网关协议**

BGP共使用四种报文

1. 打开报文（open）：和相邻的BGP发言人建立关系
2. 更新报文（update）：发送某一路由的信息，列出要撤销的多条路由
3. 保活报文（keepalive）：用于确认打开报文，并周期性证实邻站关系（在没有update时，周期性证实邻站的连通性
4. 通知报文（notification）：发送检测到的差错

### 特点
1. BGP交换路由信息的节点数量级是自治系统的数量级，比AS中的网络数少得多
2. 每个AS中BGP发言人数量很少，使得AS之间路由选择不过分复杂
3. **BGP支持CIDR**，路由表包括：目的网络前缀、下一跳、到达该目的网络需要经过的AS序列
4. **BGP刚运行时，BGP的邻站交换整个BGP路由表，此后只在发生变化时更新需要变化的部分**

# 4.6 IP组播
## 4.6.1 组播的概念
1. 源计算机一次发送的单个分组可以抵达一个组地址标识的若干目标主机，并被正确接受
2. **组播仅仅应用于UDP，而不是TCP**
3. **IPv4中用D类地址空间**，IPv6中一部分地址空间保留给组播组
4. 主机使用**IGMP**（因特网组管理协议）加入组播组
5. **主机组播时仅发送一份数据，只有数据在传送路径上出现分岔时才将分组复制后转发。组播需要路由器的支持才能实现，可以运行组播协议的路由器称为组播路由器**

## 4.6.2 IP组播地址
1. IP组播地址使用D类地址格式，前四位固定1110，因此D类地址范围224.0.0.0~239.255.255.255
2. 首部中协议字段=2，表示使用IGMP

IP组播的特点：

1. 组播数据报**不提供可靠交付**
2. **组播地址只能用于目的地址，不能用于源地址**
3. 对组播数据报**不产生ICMP差错报文**（因此如果ping一个组播地址，永远不会收到响应
4. **并非所有D类地址都可以作为组播地址**

### 硬件组播
IP组播分为：在本局域网内进行硬件组播、在因特网范围内进行组播

LANA拥有的以太网组播地址范围：**01-00-5E-00-00-00～01-00-5E-7F-FF-FF**

1. 每个地址中，只有23位可用于组播（前9位固定01-00-5E-0）
2. 后23位和D类IP地址的23位一一对应，因此D类IP地址的28位地址中有5位不能用来构成以太网MAC地址
3. 组播IP地址与以太网硬件地址的映射关系不唯一，因此收到组播数据报的主机，还要在IP层进行软件过滤，将不是该主机的数据报丢弃

![请添加图片描述](https://img-blog.csdnimg.cn/3633b31fd1d34a7aa2f23196ae99bfcc.jpeg)
## 4.6.3 IGMP与组播路由算法
IGMP：用于十路由器知晓组播成员的信息
组播路由选择协议：用于将组播数据报用较小代价传送给所有组成员

1. IGMP不清楚IP组播组包含的成员数，也不知道成员分布在哪些网络上，**只知道本地局域网上是否有主机参加或退出了某个组播组**
2. 当某台主机加入新的组播组时，该主机想组播组的组播地址发送一个IGMP报文
3. 本地组播路由器周期性探寻本局域网的主机，只要有主机响应，那么认为改组活跃；反之，不再将改组成员关系转发给其他组播路由器
4. 组播路由选择：找出以源主机为根节点的组播转发树。每个分组在每条链路上只传送一次，不同多播组对应不同转发树；同一个多播组对不同源点也会有不同的多播转发树
5. 实现因特网组播，主要有三种路由算法：链路状态、距离-向量、协议无关组播（PIM

## 4.7 移动IP


![请添加图片描述](https://img-blog.csdnimg.cn/f0ef10d62bcf45d4a171231f01d2997c.png)

![请添加图片描述](https://img-blog.csdnimg.cn/d6432af516844beea0b0893121855c9f.png)
# 4.8 网络层设备
![请添加图片描述](https://img-blog.csdnimg.cn/b2349fda52bd4d788a8a3501b011a56f.png)
![请添加图片描述](https://img-blog.csdnimg.cn/dbd1c0134105456c829d889acc0df540.png)
> 1. 路由器可以分隔广播域，抑制网络上的广播风暴

![请添加图片描述](https://img-blog.csdnimg.cn/9a3622f4a01d4ed6bca840baf50bd1e8.png)

# 408 真题
（13 408）

- 路由聚合
- 最长匹配原则
- 边界网关协议BGP，基于TCP

![在这里插入图片描述](https://img-blog.csdnimg.cn/9c578bfbfc264ae08ae64d7d0e1f4394.jpeg)
